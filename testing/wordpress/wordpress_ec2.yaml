tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - https://raw.githubusercontent.com/micado-scale/tosca/v0.x.2/micado_types.yaml

repositories:
  docker_hub: https://hub.docker.com/

topology_template:
  node_templates:
    nfs-server-pod:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
         clusterIP: 10.96.0.240
         ports:
           - target: 2049
           - target: 111
             protocol: udp
      artifacts:
       image:
         type: tosca.artifacts.Deployment.Image.Container.Docker
         file: itsthenetwork/nfs-server-ubuntu
         repository: docker_hub
      interfaces:
        Kubernetes:
          create:
            implementation: Deployment
            inputs:
              name: nfs-server-container
              metadata:
                labels:
                  app: wordpress
                  tier: nfs
              securityContext:
                privileged: True
              args: ['/exports']
              strategy:
                type: Recreate

    wordpress-mysql:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
         clusterIP: None
         ports:
           - target: 3306
      artifacts:
       image:
         type: tosca.artifacts.Deployment.Image.Container.Docker
         file: mysql:5.6
         repository: docker_hub
      requirements:
        - volume:
            node: nfs-volume
            relationship:
              type: tosca.relationships.AttachesTo
              properties:
                location: /var/lib/mysql
      interfaces:
        Kubernetes:
          create:
            implementation: Deployment
            inputs:
              name: mysql
              env:
              - name: MYSQL_ROOT_PASSWORD
                value: admin
              metadata:
                labels:
                  app: wordpress
                  tier: mysql
              ports:
              - containerPort: 3306
                name: mysql
              strategy:
                type: Recreate

    nfs-volume:
      type: tosca.nodes.MiCADO.Container.Volume
      properties:
        name: nfs-volume
      interfaces:
        Kubernetes:
          create:
            inputs:
              nfs:
                server: 10.96.0.240
                path: /

    wordpress:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
         ports:
           - target: 80
             nodePort: 30010
             type: NodePort
      artifacts:
       image:
         type: tosca.artifacts.Deployment.Image.Container.Docker
         file: wordpress:5.0.3-apache
         repository: docker_hub
      requirements:
        - volume:
            node: nfs-volume
            relationship:
              type: tosca.relationships.AttachesTo
              properties:
                location: /var/www/html
      interfaces:
        Kubernetes:
          create:
            implementation: Deployment
            inputs:
              name: wordpress
              env:
              - name: WORDPRESS_DB_HOST
                value: wordpress-mysql
              - name: WORDPRESS_DB_PASSWORD
                value: admin
              metadata:
                labels:
                  app: wordpress
                  tier: frontend
              ports:
              - containerPort: 80
                name: wordpress
              strategy:
                type: Recreate
              resources:
                requests:
                  cpu: "450m"

    worker_node:
      type: tosca.nodes.MiCADO.EC2.Compute
      properties:
        region_name: ADD_YOUR_REGION_NAME_HERE (e.g. eu-west-1)
        image_id: ADD_YOUR_IMAGE_ID_HERE (e.g. ami-061a2d878e5754b62)
        instance_type: t2.medium
        security_group_ids:
          - ADD_YOUR_SECURITY_GROUP_ID_HERE (e.g. sg-93d46bf7)
      interfaces:
        Occopus:
          create:
            inputs:
              interface_cloud: ec2
              endpoint_cloud: ADD_YOUR_ENDPOINT (e.g https://ec2.eu-west-1.amazonaws.com )
      capabilities:
        host:
          properties:
            num_cpus: 2
            mem_size: 2 GB

  outputs:
    ports:
      value: { get_attribute: [ wordpress, port ]}
      
  policies:
    - scalability:
        type: tosca.policies.Scaling.MiCADO.VirtualMachine.Net.wordpress
        targets: [ worker_node ]
        properties:
          min_instances: 1
          max_instances: 3
    - scalability:
        type: tosca.policies.Scaling.MiCADO.Container.Net.wordpress
        targets: [ wordpress ]
        properties:
          constants:
            SERVICE_NAME: 'wordpress'
            SERVICE_FULL_NAME: 'wordpress'
            SERVICE_TH_MAX: '100'
            SERVICE_TH_MIN: '25'
          min_instances: 1
          max_instances: 3

policy_types:
  tosca.policies.Scaling.MiCADO.Container.Net.wordpress:
    derived_from: tosca.policies.Scaling.MiCADO
    description: base MiCADO policy defining data sources, constants, queries, alerts, limits and rules
    properties:
      alerts:
        type: list
        description: pre-define alerts for container Net
        default:
        - alert: service_overloaded
          expr: 'avg(rate(container_network_receive_bytes_total{container_label_io_kubernetes_pod_name=~"{{SERVICE_FULL_NAME}}-[^-]*-[^-]*"}[30s]))/1000 > {{SERVICE_TH_MAX}}'
          for: 30s
        - alert: service_underloaded
          expr: 'avg(rate(container_network_receive_bytes_total{container_label_io_kubernetes_pod_name=~"{{SERVICE_FULL_NAME}}-[^-]*-[^-]*"}[30s]))/1000 < {{SERVICE_TH_MIN}}'
          for: 30s
        required: true
      scaling_rule:
        type: string
        description: pre-define scaling rule for container Net
        default: |
          if len(m_nodes) == m_node_count:
            if service_overloaded and m_node_count > m_container_count-1:
              m_container_count+=1
            if service_underloaded:
              m_container_count-=1
          else:
            print('Transient phase, skipping update of containers...')
        required: true

  tosca.policies.Scaling.MiCADO.VirtualMachine.Net.wordpress:
    derived_from: tosca.policies.Scaling.MiCADO
    description: base MiCADO policy defining data sources, constants, queries, alerts, limits and rules
    properties:
      scaling_rule:
        type: string
        description: pre-define scaling rule for VM Net
        default: |
          if len(m_nodes) == m_node_count and 0 < m_time_since_node_count_changed > 60:
            if service_overloaded:
              m_node_count+=1
            elif service_underloaded:
              m_node_count-=1
          else:
            print('Transient phase, skipping update of nodes...')
        required: true
