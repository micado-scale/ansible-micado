---
- include: python-prep.yml

- name: Populate service facts
  service_facts:

- name: (k3s) Init k3s
  include_role:
    name: common
    tasks_from: k3s-init
  when: '"k3s.service" not in services'

- name: Get Service Status
  ansible.builtin.systemd:
    name: k3s
  register: k3s_service

- include: image-pulls.yml
  when: k3s_service.status.ActiveState == "active"

- include: core-install.yml

- include: security-install.yml

- include: optimizer-install.yml
  when: enable_optimizer

- include: occopus-install.yml
  when: enable_occopus

- include: terraform-install.yml
  when: enable_terraform

- name: '(k3s) Stop service'
  systemd:
    name: k3s
    state: stopped
